#textdomain wesnoth-The_Legend_Begins

[scenario]
   id="63_Vampire_Metropolis"
   next_scenario="64_Prince_of_Darkness"
   map_data="{~add-ons/The_Legend_Begins/maps/episode-3/63_Vampire_Metropolis.map}"
   name= _ "Vampire Metropolis"
   victory_when_enemies_defeated=no

   {DEFAULT_SCHEDULE_BLOOD_SET}

   {DEFAULT_MUSIC_PLAYLIST}
   {KNIGHTHOOD_GRANTING_MACRO}

   {TURNS 30 28 26}
   {TIME_OVER_DEFEAT}

   {~add-ons/The_Legend_Begins/macros/deaths.cfg}
   {~add-ons/The_Legend_Begins/macros/recurring-events.cfg}
   {~add-ons/The_Legend_Begins/macros/custom-advancement.cfg}

   {TLB_LIMIT_ARMY 1 (race=human) (Infantryman,Bowman,Cavalryman,Heavy Infantryman,Horseman,Spearman) 10 "human_troops"}
   {TLB_LIMIT_ARMY 1 (race=dwarf) (Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Scout,Dwarvish Guardsman,Dwarvish Ulfserker) 10 "dwarven_troops"}
   {TLB_LIMIT_ARMY 1 (race=gryphon) (Gryphon Rider) 3 "gryphons"}
   {TLB_LIMIT_ARMY 1 (race=troll) (Troll Whelp) 2 "trolls"}
   {TLB_LIMIT_ARMY 1 (race=orc) () 4 "orcs"}
   {TLB_LIMIT_ARMY 1 (race=wolf) () 2 "wolf_riders"}
   {TLB_LIMIT_ARMY 1 (race=aberration) (Unhatched,Scornful Watcher,Black Cat) 3 "aberrations"}

   [story]
      [part]
          music="knolls.ogg"
          story= _ "Scarcely a week had passed after that gruesome ordeal, and Jalin had accomplished establishing communications with the Mermen. Kai Alastyn, the king of the mermen, agreed to use their magic of the winds to guide the vessels to the vampire capital but refused to aid directly since the majority of his army had been decimated by the Chaos Empire and their demonic allies."
      [/part]
      [part]
          story= _ "By the time the preparations had finally been made, autumn had arrived and winter was not that far behind. Realising that wasting more time would be futile, Jahin gave the order to sail and off went the fleet."
      [/part]
      [part]
          story= _ "Sailing in ships hoisting flags of the vampire nation, Jahin had the element of surprise in his sleeves and he used it at the most opportune moment..."
      [/part]
   [/story]

   [side]
        side=1
        team_name="good"
        user_team_name= _ "New Genesis"
        id="Jahin"
        name= _ "Jahin"
        controller=human
        canrecruit=yes
        fog=no
        shroud=yes
        share_map=no
        share_view=yes
        {FLAG_VARIANT loyalist}
        {GOLD 200 180 160}
        {INCOME 5 4 3}
        recruit="Infantryman,Bowman,Cavalryman,Heavy Infantryman,Horseman,Spearman,Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Scout,Dwarvish Ulfserker,Dwarvish Guardsman,Gryphon Rider,Troll Whelp,Unhatched,Scornful Watcher,Black Cat,Life Thief,Howling Darkness"
    [/side]

    [side]
       side=2
       team_name="good"
       user_team_name= _ "Alliance of Light"
       persistent=yes
       controller=human
       canrecruit=yes
       type="Human Warlord"
       fog=no
       shroud=yes
       share_map=no
       share_view=yes
       id="Jalin"
       name= _ "Jalin"
       unrenameable=yes
       {FLAG_VARIANT loyalist}
       {GOLD 200 180 160}
       {INCOME 5 4 3}
       recruit="Bowman,Longbowman,Infantryman,Swordsman,Spearman,Pikeman,Horseman,Cavalryman"
    [/side]

    {TLB_RECRUIT_PER_TURN 2 Swordsman 2}
    {TLB_RECRUIT_PER_TURN 2 Pikeman 2}
    {TLB_RECRUIT_PER_TURN 2 Longbowman 2}

    [side]
       side=3
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Duchess"
       id="Silvana"
       hidden=yes
       name= _ "Princess Silvana"
       {FLAG_VARIANT long}
       {GOLD 800 1100 1400}
       recruit=
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]
    [/side]

    {STARTING_VILLAGES 3 7}

    [side]
       side=4
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Duchess"
       id="Sylvia"
       hidden=yes
       name= _ "Princess Silvia"
       {FLAG_VARIANT long}
       {GOLD 800 1100 1400}
       recruit=
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]
    [/side]

    {STARTING_VILLAGES 4 8}

    [side]
       side=5
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Sire"
       id="Blaine"
       name= _ "Lord Blaine"
       {FLAG_VARIANT long}
       {GOLD 800 1100 1400}
       {INCOME 8 14 18}
       recruit=
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]
    [/side]

    {STARTING_VILLAGES 5 8}

    [side]
       side=6
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Day Hunter"
       gender=female
       id="Winta"
       name= _ "Winta"
       {FLAG_VARIANT long}
       {GOLD 800 1100 1400}
       {INCOME 8 14 18}
       recruit=
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]
    [/side]

    {STARTING_VILLAGES 6 10}

    [side]
       side=7
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Methusalem"
       id="Holt"
       name= _ "Holt"
       {FLAG_VARIANT long}
       {GOLD 800 1100 1400}
       {INCOME 8 14 18}
       recruit="Vampire Duelist, Vampire Noble, Half Blood, Blood Manipulator, Flesh Artisan, Blood Apprentice, Thin Blood, Fledgeling, Blood Hulk"
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]
    [/side]

    {STARTING_VILLAGES 7 10}

    #ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Blood Manipulator" 7}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Blood Hulk" 6}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Flesh Artisan" 5}
    #endif

    #ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Blood Manipulator" 8}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Blood Hulk" 7}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Flesh Artisan" 6}
    #endif

    #ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Blood Manipulator" 9}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Blood Hulk" 7}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Flesh Artisan" 6}
    #endif

    [event]
       name="die"
       [filter]
          id="Holt"
       [/filter]
       {VARIABLE escape_secured yes}

       [message]
          speaker="Jahin"
          message= _ "The vampires are still coming. We must keep this location firmly under our control and prevent the enemy from compromising us."
       [/message]
    [/event]

    [side]
       side=8
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Vampire Noble"
       id="Corbin"
       name= _ "Corbin"
       gender=male
       {FLAG_VARIANT long}
       {GOLD 50 60 80}
       recruit="Fledgeling, Thin Blood, Blood Apprentice, Gargoyle"
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]

       {GENERIC_UNIT 8 "Twilight Walker" 15 49}{GUARDIAN}
       {GENERIC_UNIT 8 "Sword Dancer" 16 49}{GUARDIAN}
       {GENERIC_UNIT 8 "Sangel" 17 50}{GUARDIAN}
       {GENERIC_UNIT 8 "Terror Hulk" 13 50}{GUARDIAN}
       {GENERIC_UNIT 8 "Sire" 17 52}{GUARDIAN}
       {GENERIC_UNIT 8 "Mistress" 20 53}{GUARDIAN}
       {GENERIC_UNIT 8 "Day Hunter" 9 48}{GUARDIAN}

       {GENERIC_UNIT 8 "Twilight Walker" 22 54}{GUARDIAN}
       {GENERIC_UNIT 8 "Sword Dancer" 21 56}{GUARDIAN}
       {GENERIC_UNIT 8 "Sangel" 18 56}{GUARDIAN}
       {GENERIC_UNIT 8 "Terror Hulk" 13 56}{GUARDIAN}
       {GENERIC_UNIT 8 "Sire" 9 57}{GUARDIAN}
       {GENERIC_UNIT 8 "Mistress" 7 54}{GUARDIAN}
       {GENERIC_UNIT 8 "Day Hunter" 53 37}{GUARDIAN}

       {GENERIC_UNIT 8 "Twilight Walker" 60 32}{GUARDIAN}
       {GENERIC_UNIT 8 "Sword Dancer" 56 41}{GUARDIAN}
       {GENERIC_UNIT 8 "Sangel" 47 46}{GUARDIAN}
       {GENERIC_UNIT 8 "Terror Hulk" 5 52}{GUARDIAN}
       {GENERIC_UNIT 8 "Sire" 49 38}{GUARDIAN}
       {GENERIC_UNIT 8 "Mistress" 55 37}{GUARDIAN}
       {GENERIC_UNIT 8 "Day Hunter" 56 32}{GUARDIAN}

    [/side]

    {STARTING_VILLAGES 8 10} 

    [side]
       side=9
       team_name="vampires"
       user_team_name= _ "Vampires"
       controller=ai
       canrecruit=yes
       type="Vampire Noble"
       gender=female
       id="Oleta"
       name= _ "Oleta"
       {FLAG_VARIANT long}
       {GOLD 50 60 80}
       recruit="Fledgeling, Thin Blood, Blood Apprentice, Gargoyle"
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.95}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.05}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}

          [goal]
             name="target"
             [criteria]
                 id="Jahin"
             [/criteria]
             value=400
          [/goal]
          [goal]
             name="target"
             [criteria]
                 id="Jalin"
             [/criteria]
             value=300
          [/goal]
       [/ai]

       {GENERIC_UNIT 9 "Twilight Walker" 55 48}{GUARDIAN}
       {GENERIC_UNIT 9 "Sword Dancer" 58 41}{GUARDIAN}
       {GENERIC_UNIT 9 "Sangel" 4 50}{GUARDIAN}
       {GENERIC_UNIT 9 "Terror Hulk" 44 36}{GUARDIAN}
       {GENERIC_UNIT 9 "Sire" 58 36}{GUARDIAN}
       {GENERIC_UNIT 9 "Mistress" 53 34}{GUARDIAN}
       {GENERIC_UNIT 9 "Day Hunter" 56 49}{GUARDIAN}

       {GENERIC_UNIT 9 "Twilight Walker" 60 55}{GUARDIAN}
       {GENERIC_UNIT 9 "Sword Dancer" 7 48}{GUARDIAN}
       {GENERIC_UNIT 9 "Sangel" 49 36}{GUARDIAN}
       {GENERIC_UNIT 9 "Terror Hulk" 59 35}{GUARDIAN}
       {GENERIC_UNIT 9 "Sire" 53 43}{GUARDIAN}
       {GENERIC_UNIT 9 "Mistress" 51 47}{GUARDIAN}
       {GENERIC_UNIT 9 "Day Hunter" 63 57}{GUARDIAN}
    [/side]

    {STARTING_VILLAGES 9 10}

    [side]
       side=10
       team_name="good"
       user_team_name= _ "Alliance of Light"
       color=khaki
       id="Vigor"
       name= _ "Vigor Red-Tusk"
       type="Orcish Warlord"
       controller=ai
       canrecruit=yes
       x,y=47,54
       village_gold=1
       share_view=yes
       share_map=no
       shroud=yes
       fog=no
       {FLAG_VARIANT ragged}
       {GOLD 800 750 700}
       {INCOME 8 7 6}
       recruit="Orcish Warrior,Orcish Crossbowman,Orcish Grunt,Orcish Archer,Goblin Pillager,Troll,Troll Rocklobber,Troll Shaman,Troll Mystic,Troll Whelp,Saurian Ambusher,Saurian Soothsayer,Saurian Augur,Orcish Warlock,Orcish Shaman"
       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT time_of_day chaotic}
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.80}
          {AI_SIMPLE_ALWAYS_ASPECT leader_aggression -10}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.50}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}
          {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
          {ATTACK_DEPTH 5 5 4}

          [goal]
              name="protect_unit"
              [criteria]
                  side=1
              [/criteria]
              value=200
              protect_radius=8
          [/goal]
       [/ai]

       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT time_of_day lawful}
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.40}
          {AI_SIMPLE_ALWAYS_ASPECT leader_aggression -10}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.50}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}
          {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
          {ATTACK_DEPTH 5 5 4}

          [goal]
              name="protect_unit"
              [criteria]
                  side=1
              [/criteria]
              value=200
              protect_radius=8
          [/goal]
       [/ai]

    [/side]

    [event]
        name="die"
        [filter]
            id="Vigor"
        [/filter]
        [message]
            speaker="Jahin"
            message= _ "Oh, no! General Red-Tusk has fallen! Now, we're severely outnumbered!"
        [/message]
        [endlevel]
            result="defeat"
        [/endlevel]
    [/event]

    [side]
       side=11
       team_name="good"
       user_team_name= _ "Minotaurs"
       controller=ai
       canrecruit=yes
       id="Rudolph"
       name= _ "Rudolph"
       share_view=yes
       share_map=no
       shroud=yes
       x,y=42,54
       fog=no
       type="Minotaur Overlord"
       {FLAG_VARIANT ragged}
       color=rust
       {GOLD 800 750 700}
       {INCOME 8 7 6}
       recruit="Minotaur Gore,Minotaur Rouser,Minotaur Cutthroat,Minotaur Slayer,Minotaur Shaman,Minotaur Mystic,Minotaur Savage,Boar Rider,Boar Knight,Minotaur Savage,Minotaur Behemoth,Minotaur Ancient Behemoth,Gnoll,Gnoll Marksman"

       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT time_of_day chaotic}
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.80}
          {AI_SIMPLE_ALWAYS_ASPECT leader_aggression -10}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.50}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}
          {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
          {ATTACK_DEPTH 5 5 4}

          [goal]
              name="protect_unit"
              [criteria]
                  side=2
              [/criteria]
              value=200
              protect_radius=8
          [/goal]
       [/ai]

       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT time_of_day lawful}
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.40}
          {AI_SIMPLE_ALWAYS_ASPECT leader_aggression -10}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.50}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}
          {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
          {ATTACK_DEPTH 5 5 4}

          [goal]
              name="protect_unit"
              [criteria]
                  side=2
              [/criteria]
              value=200
              protect_radius=8
          [/goal]
       [/ai]

    [/side]

    [event]
        name="die"
        [filter]
            id="Rudolph"
        [/filter]
        [message]
            speaker="Jahin"
            message= _ "Oh, no! We've lost the minotaur lord! We're severely outnumbered now!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [side]
        side=12
        color=yellow
        team_name="good,vampires"
        user_team_name= _ "Ships"
        no_leader=yes
        controller=null
        {FLAG_VARIANT ragged}
        hidden=yes

        {GENERIC_UNIT 12 "Galleon" 39 14}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 37 15}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 35 16}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 35 18}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 37 17}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 40 16}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 36 16}{GUARDIAN}
        
        {GENERIC_UNIT 12 "Galleon" 49 58}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 47 55}{GUARDIAN}
        {GENERIC_UNIT 12 "Galleon" 44 56}{GUARDIAN}
    [/side]

    [side]
       side=13
       team_name="good"
       user_team_name= _ "Mermen"
       controller=ai
       canrecruit=yes
       id="Alastyn"
       name= _ "Kai Alastyn"
       share_view=yes
       share_map=no
       shroud=yes
       x,y=68,65
       fog=no
       type="Merman Triton"
       {FLAG_VARIANT loyalist}
       color=steel_blue
       {GOLD 800 750 700}
       {INCOME 8 7 6}
       recruit="Merman Fighter, Merman Hunter, Mermaid Initiate, Merman Warrior, Merman Netcaster, Merman Spearman, Mermaid Priestess, Mermaid Enchantress"

       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT time_of_day lawful}
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.80}
          {AI_SIMPLE_ALWAYS_ASPECT leader_aggression -10}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.50}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}
          {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
          {ATTACK_DEPTH 5 5 4}
       [/ai]

       [ai]
          {AI_SIMPLE_ALWAYS_ASPECT time_of_day chaotic}
          {AI_SIMPLE_ALWAYS_ASPECT aggression 0.40}
          {AI_SIMPLE_ALWAYS_ASPECT leader_aggression -10}
          {AI_SIMPLE_ALWAYS_ASPECT caution 0.50}
          {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat no}
          {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
          {ATTACK_DEPTH 5 5 4}
       [/ai]

       [ai]
          [avoid]
              terrain=Ds,Re,Cmy,Kmy,Gd,Gll,Gd^Fdf,Rr,Rr^Vhc,Hh,Gd^*,Gll^*,Cvj,Kvj,Rr^*
          [/avoid]
       [/ai]

    [/side]

    [event]
        name="die"
        [filter]
            id="Alastyn"
        [/filter]
        [message]
            speaker="Jahin"
            message= _ "Oh, no! We needed to keep the merman king alive! Now, nothing is holding the vampires back! We're doomed!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    {TLB_TELEPORTATION_RUNE 3,4 2 54 20 59 29}
    {TLB_TELEPORTATION_RUNE 3,4 3 17 39 62 30}

    {PLACE_IMAGE "items/sword.png" 37 38}
    [label]
       x,y=37,38
       text= _ "Vampire Broadsword"
    [/label]

    # Key and sword event(s)

    [event]
       name="moveto"
       first_time_only=yes
       [filter]
          x,y=35,36
          side=1
       [/filter]

       [if]
          {VARIABLE_CONDITIONAL key_found equals no}
          [then]
             [message]
                 speaker="unit"
                 message= _ "Hey, everybody, look! I found a platinum steel door. Examining it closer, I see a keyhole and an image of a sword engraved on it. This must be the place where Prince Laurent keeps his legendary sword. It's a shame that we cannot take it."
             [/message]
          [/then]
       [/if]
       [if]
          {VARIABLE_CONDITIONAL key_found equals yes}
          [then]
             [message]
                 speaker="unit"
                 message= _ "Hey, everybody, look! I found a platinum steel door. Examining it closer, I see a keyhole and an image of a sword engraved on it. This must be the place where Prince Laurent keeps his legendary sword. We looted a key from the deceased prince and I shall use it."
             [/message]
             {NARRATOR_MESSAGE ( _ "<i>No sooner had the key been inserted, the wall descends below.</i>")}
             [terrain]
                 x,y=36,36
                 terrain=Uu
             [/terrain]
          [/then]
       [/if]

       {CLEAR_VARIABLE key_found}
       {VARIABLE sword_taken no}
    [/event]

    [event]
       name="moveto"
       first_time_only=no

       [filter]
           side=1
           x,y=37,38
       [/filter]
       
       [if]
            [variable]
                name=sword_taken
                equals=no
            [/variable]

            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "Do you want this unit to pick up the sword?"
                    [option]
                        message= _ "Yes"
                        [command]
                            [object]
                                id=vampire_broadsword
                                name= _ "Laurent's Broadsword"
                                image="attacks/greatsword-human.png"
                                duration=forever
                                
                                description= _ "This massive blade was created centuries ago by long-forgotten vampire weapon smiths, who imbued the bluish steel with the magic of accuracy. It's first owner was Prince Laurent and now, choose it's next one (remember Orcs and Dwarves don't use weapons designed predominantly for humans)..."
                                cannot_use_message= _ "Only a seasoned warrior can wield this sword!"

                                # A word of advice:
                                # This new weapon might be very useful but Jahin should not use it,
                                # even though he can.
                                # Give it to a Royal Guard (other than Fairuz) or Grand Knight

                                [filter]
                                    type=Grand Knight, Knight, Swordsman, Royal Guard, Warmaster, Captain
                                    x,y=37,38
                                [/filter]
                                [then]
                                    [remove_item]
                                        x,y=37,38
                                    [/remove_item]
                                    [message]
                                        speaker=narrator
                                        image="wesnoth-icon.png"
                                        message= _ "As you place your hand around the glittering leather hilt, the sword radiates an aura of power. The sword is quite heavy and you realise that you need more practice with it to utilise it further."
                                    [/message]
                                    {VARIABLE sword_taken yes}
                                [/then]
                                [effect]
                                    apply_to=new_attack
                                    # the name is intentionally "sword" so that the existing sword animation of the unit will be used
                                    name=sword
                                    description= _ "heavy broadsword"
                                    icon=attacks/greatsword-human.png
                                    type=blade
                                    range=melee
                                    [specials]
                                        [chance_to_hit]
                                            id=precision
                                            name= _ "precision"
                                            description={WEAPON_SPECIAL_CAPTION ( _ "Precision")}+ _ "When used offensively, this attack always has at least a 50% chance to hit."
                                            value=50
                                            cumulative=yes
                                            active_on=offense
                                        [/chance_to_hit]
                                        {WEAPON_SPECIAL_CLEAVE}
                                    [/specials]
                                    damage=16
                                    number=3
                                [/effect]

                                # this makes sure that any existing sword attack gets removed
                                [effect]
                                    apply_to=remove_attacks
                                    range=melee
                                    type=blade
                                [/effect]

                            [/object]
                        [/command]
                    [/option]

                    [option]
                        message= _ "No"

                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]

            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]
    
    [event]
        name="prestart"

        [store_unit]
            [filter]
               id="Jahin"
            [/filter]
            kill=yes
            variable="stored.jahin"
        [/store_unit]

        [store_unit]
            [filter]
                id="Jalin"
            [/filter]
            kill=yes
            variable="stored.jalin"
        [/store_unit]

        [store_unit]
            [filter]
                id="Vigor"
            [/filter]
            kill=yes
            variable="stored.vigor"
        [/store_unit]

        [store_unit]
            [filter]
                id="Rudolph"
            [/filter]
            kill=yes
            variable="stored.rudolph"
        [/store_unit]

        [objectives]
            side=1
            [objective]
                description= _ "Find a way to reach the lair of the High Methusalem"
                condition="win"
            [/objective]
            [objective]
                description= _ "Death of Jahin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any allied leader"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any hero unit"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                carryover_percentage=20
                bonus=yes
            [/gold_carryover]

            [note]
                description= _ "It would be worth your while to recall as many veterans as possible."
            [/note]
            [note]
                description= _ "Your mermen allies shall only attack vampires that are on or near water hexes. Use this to your advantage." 
            [/note]
        [/objectives]

        [objectives]
            side=2
            [objective]
                description= _ "Hold off the vampires until Jahin reaches the castle of the High Methusalem"
                condition="win"
            [/objective]
            [objective]
                description= _ "Death of Jalin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any allied leader"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any hero unit"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                carryover_percentage=20
                bonus=yes
            [/gold_carryover]

            [note]
                description= _ "It would be worth your while to recall as many veterans as possible."
            [/note]
            [note]
                description= _ "Your mermen allies shall only attack vampires that are on or near water hexes. Use this to your advantage." 
            [/note]
        [/objectives]

        {GENERIC_UNIT 12 "Galleon" 46 66}{GUARDIAN}
        [+unit]
            id="Rudolph_Galleon"
        [/unit]
        {GENERIC_UNIT 12 "Galleon" 47 64}{GUARDIAN}
        [+unit]
            id="Vigor_Galleon"
        [/unit]
        {GENERIC_UNIT 12 "Galleon" 44 66}{GUARDIAN}
        [+unit]
            id="Jalin_Galleon"
        [/unit]
        {GENERIC_UNIT 12 "Galleon" 41 65}{GUARDIAN}
        [+unit]
            id="Jahin_Galleon"
        [/unit]

        [store_locations]
            x=10-43
            y=31-52
            terrain=Wwb,Xu,Xos,Xol,Rr,Rp,Urb,Uu,Urb^Ii,Rrc,Xu^Uov,Xos^Uov,Ur^Srg
            variable=underground_hexes
        [/store_locations]

        [time_area]
           find_in=underground_hexes
           {UNDERGROUND}
        [/time_area]

        {CLEAR_VARIABLE underground_hexes} 
    [/event]

    [event]
        name="die"
        first_time_only=no

        [filter]
           side=3,4,5,6
        [/filter]

        [gold]
           side=$unit.side
           amount=$($unit.cost/2)
        [/gold]
    [/event]

    [event]
        name="die"
        first_time_only=no

        [filter]
            side=2,10,11,13
        [/filter]

        [gold]
            side=$unit.side
            amount=$($unit.cost/2)
        [/gold]
    [/event]

    {FORCE_CHANCE_TO_HIT () (id="Silvana") 0 ()}
    {FORCE_CHANCE_TO_HIT () (id="Sylvia") 0 ()}
    {FORCE_CHANCE_TO_HIT () (id="Winta") 30 ()}
    {FORCE_CHANCE_TO_HIT () (id="Blaine") 30 ()}

    [event]
       name="start"

       {CLEAR_FOG 1 45 57 12}
       {CLEAR_FOG 2 45 57 12}
       
       {SCROLL_TO 41 65}
       {DELAY 100}

       {MOVE_UNIT (id="Jahin_Galleon") 42 57}

       {SCROLL_TO 44 66}
       {DELAY 100}
       {MOVE_UNIT (id="Jalin_Galleon") 50 57}

       {SCROLL_TO 45 53}
       
       [message]
           speaker="Corbin"
           message= _ "Are we expecting any ships today?"
       [/message]
       [message]
           speaker="Oleta"
           message= _ "No, not at all."
       [/message]
       [message]
           speaker="Corbin"
           message= _ "Then why are those two ships..."
       [/message]

       {SCROLL_TO 42 57}

       [unstore_unit]
           variable="stored.jahin"
       [/unstore_unit]
       [unstore_unit]
           variable="stored.jalin"
       [/unstore_unit]

       {CLEAR_VARIABLE stored.jahin,stored.jalin}

       [recall]
           id="Fairuz"
       [/recall]
       [recall]
           id="Sreeyoshee"
       [/recall]
       [recall]
           id="Ashhab"
       [/recall]
       [recall]
           id="Krog"
       [/recall]

       [recall]
           id="Shifti"
       [/recall]
       [recall]
           side=2
           type="Royal Guard, Halberdier, Master Bowman, Pikeman, Swordsman, Longbowman"
       [/recall]
       [recall]
           side=2
           type="Royal Guard, Halberdier, Master Bowman, Pikeman, Swordsman, Longbowman"
       [/recall]
       [recall]
           side=2
           type="Royal Guard, Halberdier, Master Bowman, Pikeman, Swordsman, Longbowman"
       [/recall]

       [message]
           speaker="Ashhab"
           message= _ "Hello, blood-suckers! Get ready to meet your end!"
       [/message]
       [message]
           speaker="Jahin"
           message= _ "Jalin, let us quickly siege those keeps. It is imperative that we have this port under our control if our main force is to arrive."
       [/message]
       [message]
           speaker="Jalin"
           message= _ "Alright. Let us get to it then."
       [/message]

       {VARIABLE located_go_to no}
       {VARIABLE turn_counter 0}
       {VARIABLE escape_secured no}
       {VARIABLE methusalem_revealed no}

       {UNCLEAR_FOG}
       
    [/event]

    [event]
       name="turn 3"
       first_time_only=yes

       {CLEAR_FOG 1 59 43 8}
       {FAKE_UNIT_MOVE 45 59 53 43 9 ("Vampiric Blood Dat") ()}
       
       {GENERIC_UNIT 9 "Vampiric Blood Bat" 59 43}
       [+unit]
           id="Messenger1"
       [/unit]

       {TRANSFORM_UNIT (id="Messenger1") ("Half Blood")}      
       
       [message]
           speaker="Messenger1"
           message= _ "Commander, we are being attacked!"
       [/message]
       [message]
           speaker="Winta"
           message= _ "What?! Prepare for battle!"
       [/message]

       {UNCLEAR_FOG}

       [set_recruit]
           side=5
           recruit="Fledgeling, Thin Blood, Blood Apprentice, Blood Hulk, Vampire Duelist, Vampire Noble, Half Blood, Blood Manipulator"
       [/set_recruit]
       [set_recruit]
           side=6
           recruit="Fledgeling, Thin Blood, Blood Apprentice, Blood Hulk, Vampire Duelist, Vampire Noble, Half Blood, Blood Manipulator"
       [/set_recruit]
    [/event]

    [event]
       name="turn 4"
       first_time_only=yes

       [message]
           speaker="Fairuz"
           message= _ "Jahin, do you know where this High Methusalem might be hiding?"
       [/message]
       [message]
           speaker="Jahin"
           message= _ "To tell the truth, Fairuz, I have no idea. My original plan was to kill every vampire walking about and force him to reveal himself."
       [/message]
       [message]
           speaker="Shifti"
           message= _ "<i>(flabbergasted)</i> Jahin, I taught you so much about battle strategies and you have to choose this one! I am greatly disappointed."
       [/message]
       [message]
           speaker="Jalin"
           message= _ "Let's continue that conversation another time, shall we? Right now, we need siege weapons!"
       [/message]

       [message]
           speaker="Fairuz"
           message= _ "The catapult and the ballistas are currently aboard the Minotaurs' ship. We shall have access to them when our allies arrive."
       [/message]

       [message]
           speaker="Sreeyoshee"
           message= _ "Guys, if you let me concentrate, I can tell you where the High Methusalem might be. His aura should not be that hard to detect."
       [/message]
       [message]
           speaker="Jahin"
           message= _ "Alright, we shall keep the enemy away from you."
       [/message]

       [objectives]
            side=1
            silent=no
            [objective]
                description= _ "Find a way to reach the lair of the High Methusalem"
                condition="win"
            [/objective]
            [objective]
                description= _ "Death of Jahin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any allied leader"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of any hero unit"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                carryover_percentage=20
                bonus=yes
            [/gold_carryover]

            [note]
                description= _ "It would be worth your while to recall as many veterans as possible."
            [/note]
            [note]
                description= _ "Let Sreeyoshee rest for successive 3 turns and she shall tell you the location of your enemy."
            [/note]
        [/objectives]
    [/event]

    [event]
       name="new turn"
       first_time_only=no

       [if]

          {VARIABLE_CONDITIONAL methusalem_revealed equals no}

          [then]

             [if]
                {VARIABLE_CONDITIONAL located_go_to equals no}
                [then]
                   [store_unit]
                      [filter]
                         id="Sreeyoshee"
                      [/filter]
                      kill=no
                      variable="sreeyoshee_temp"
                   [/store_unit]

                   [if]
                     {VARIABLE_CONDITIONAL sreeyoshee_temp.resting equals yes}
                     [then]
                        {VARIABLE_OP turn_counter add 1}
                     [/then]
                     [else]
                        {VARIABLE turn_counter 0}
                     [/else]
                   [/if]

                   {CLEAR_VARIABLE sreeyoshee.temp}
                [/then]
             [/if]

             [if]
               {VARIABLE_CONDITIONAL turn_counter equals 3}
               [then]
                  [message]
                     speaker="Sreeyoshee"
                     message= _ "Okay, I know where the vampire king lurks..."
                  [/message]

                  {SCROLL_TO 42 30}
                  {DELAY 100}

                  {CLEAR_FOG 1 42 30 2}

                  {HIGHLIGHT_IMAGE 42 30 "items/gohere.png" "misc/goal-highlight.png"}

                  {UNCLEAR_FOG}

                  [scroll_to_unit]
                      id="Sreeyoshee"
                  [/scroll_to_unit] 
                  [message]
                      speaker="Sreeyoshee"
                      message= _ "...but, his island appears to be protected by some sort of magical barrier."
                  [/message]
                  [message]
                      speaker="Jahin"
                      message= _ "Thank you, Sreeyoshee. We shall find a way to reach that villain!"
                  [/message]

                  {VARIABLE located_go_to yes}
                  {VARIABLE methusalem_revealed yes}

                  [objectives]
                     side=1
                     silent=no
                     [objective]
                        description= _ "Reach the High Methusalem's lair with Jahin (42,30)"
                        condition="win"
                     [/objective]
                     [objective]
                        description= _ "Death of Jahin"
                        condition="lose"
                     [/objective]
                     [objective]
                        description= _ "Death of any allied leader"
                        condition="lose"
                     [/objective]
                     [objective]
                        description= _ "Death of any hero unit"
                        condition="lose"
                     [/objective]
                     {TURNS_RUN_OUT}

                     [gold_carryover]
                         carryover_percentage=20
                         bonus=yes
                     [/gold_carryover]       
                  [/objectives]   
                [/then]
             [/if]

          [/then]

       [/if]

       [if]
          {VARIABLE_CONDITIONAL methsalem_revealed equals yes}
          [then]
             {CLEAR_VARIABLE located_go_to,turn_counter}
          [/then]
       [/if]
    [/event]

    {TLB_BALLISTA_CONFIGURATION 2 One 4}
    {TLB_BALLISTA_CONFIGURATION 2 Two 4}

    {CATAPULT_CONFIGURATION 2 ()}

    # turn 7
    # arrival of allies

    [event]
       name="turn 7"
       first_time_only=yes

       {MOVE_UNIT (id="Vigor_Galleon") 48 54}
       {MOVE_UNIT (id="Rudolph_Galleon") 41 54}

       [unstore_unit]
           variable="stored.vigor"
       [/unstore_unit]

       [unstore_unit]
           variable="stored.rudolph"
       [/unstore_unit]

       {CLEAR_VARIABLE stored.vigor,stored.rudolph}

       [message]
           speaker="Rudolph"
           message= _ "Accursed blood-sucking vermin, you have tortured my kind long enough! To battle, my brethren!"
       [/message]

       {MOVE_UNIT (id="Rudolph") 48 51}

       [message]
           speaker="Vigor"
           message= _ "Stab, smite and slay!"
       [/message]

       {MOVE_UNIT (id="Vigor") 41 52}

       [terrain]
           x=47,49,47,48,42,40,42
           y=51,52,52,52,52,51,51
           terrain="Ce"
       [/terrain]

       [terrain]
           x=48,41
           y=51,52
           terrain="Ke"
       [/terrain]

       {LOYAL_UNIT 2 "Catapult" 45 53}

       {LOYAL_UNIT 2 "Ballista" 41 53}
       [+unit]
           id="One"
           name= _ "Ballista One"
       [/unit]
       {LOYAL_UNIT 2 "Ballista" 46 53}
       [+unit]
           id="Two"
           name= _ "Ballista Two"
       [/unit]

       [message]
           speaker="Jahin"
           message= _ "Our allies have arrived! Now, let's eliminate the enemy for good! Attack!"
       [/message]

       [message]
           speaker="Fairuz"
           message= _ "Our siege weapons are ready, Jahin."
       [/message]
       [message]
           speaker="Jahin"
           message= _ "Jalin, take the siege weapons. You can utilise them better."
       [/message]
       [message]
           speaker="Jalin"
           message= _ "Alright."
       [/message]
    [/event]

    # turn 11
    # main vampire army initiatizes

    [event]
       name="turn 11"
       first_time_only=yes
       {CLEAR_FOG 1 21 23 4}
       {FAKE_UNIT_MOVE 58 21 22 23 8 ("Vampiric Dread Bat") ()}

       {SCROLL_TO 21 23}
      
       {GENERIC_UNIT 8 "Vampiric Dread Bat" 21 23}
       [+unit]
          id="Messenger2"
       [/unit]

       {TRANSFORM_UNIT (id="Messenger2") ("Twilight Walker")}

       [message]
          speaker="Messenger2"
          message= _ "My lady, we are under attack."
       [/message]
       [message]
          speaker="Silvana"
          message= _ "Preposterous! No one has ever been foolish enough to attack us here! Who are the invaders?"
       [/message]
       [message]
          speaker="Fairuz"
          message= _ "That would be us, your royal pain-in-the-ass!"
       [/message]
       [message]
          speaker="Silvana"
          message= _ "Well, if it is not the foolish boy whom I wanted as my personal slave. I am surprised that you have it made this far. My brothers and sisters might have been weak, but I am the eldest and the strongest. Let us see if you stand a chance."
       [/message]
       {DELAY 500}
       [message] 
          speaker="Silvana"
          message= _ "Do not mind me asking but who is your leader?"
       [/message]
       [message]
          speaker="Jahin"
          message= _ "That would be me, princess."
       [/message]
       [message]
          speaker="Silvana"
          message= _ "You must be a gifted youth for this is the very first time our capital has been assaulted. Leaders such as you are rare and thus, it saddens me to kill one such as you."
       [/message]
       [message]
          speaker="Jahin"
          message= _ "Let us see who dies first."
       [/message]
       {UNCLEAR_FOG}

       [set_recruit]
          side=3
          recruit="Fledgeling, Thin Blood, Blood Apprentice, Blood Hulk, Vampire Noble, Vampire Duelist, Sword Dancer, Half Blood, Twilight Walker, Blood Manipulator, Sangel, Flesh Artisan, Terror Hulk, Vampiric Dread Bat, Day Hunter"
       [/set_recruit]
       [set_recruit]
          side=4
          recruit="Fledgeling, Thin Blood, Blood Apprentice, Blood Hulk, Vampire Noble, Vampire Duelist, Sword Dancer, Half Blood, Twilight Walker, Blood Manipulator, Sangel, Flesh Artisan, Terror Hulk, Vampiric Dread Bat, Day Hunter"
       [/set_recruit]
    [/event]

    

    # The place Jahin needs to be positioned

    [event]
       name="moveto"
       first_time_only=no

       [filter]
           id="Jahin"
           x,y=42,30
       [/filter]

       [if]
          {VARIABLE_CONDITIONAL escape_secured equals yes}
          [then]
             [message]
                 speaker="Jalin"
                 message= _ "Jahin, do not worry about us. We shall keep the vampires occupied. Slay the High Methusalem!"
             [/message]
             [message]
                 speaker="Rudolph"
                 message= _ "Don't fail us, Boy. We're all counting on you."
             [/message]

             [message]
                 speaker="Jahin"
                 message= _ "Fairuz, are you ready for this?"
             [/message]
             [message]
                 speaker="Fairuz"
                 message= _ "I was born ready!"
             [/message]
             [message]
                 speaker="Jahin"
                 message= _ "Sreeyoshee?"
             [/message]
             [message]
                 speaker="Sreeyoshee"
                 message= _ "Let us free this world from a tyrant. Onwards!"
             [/message]

             [message]
                 speaker="Ashhab"
                 message= _ "Jahin, I shall stay here with some of the men and cut off the High Methusalem from reinforcements. I hope you don't mind me sitting this battle out."
             [/message]
             [message]
                 speaker="Krog"
                 message= _ "Krog do same as well. Krog defend tunnel from vampires so Jahin can kill vampire king!"
             [/message]
             [message]
                 speaker="Jahin"
                 message= _ "Okay, do what you have to do. Now, let's end this once and for all!"
             [/message]

             [store_unit]
                 [filter]
                    id="Ashhab"
                 [/filter]
                 kill=yes
                 variable="stored.ashhab"
             [/store_unit]
             [store_unit]
                 [filter]
                    id="Krog"
                 [/filter]
                 kill=yes
                 variable="stored.krog"
             [/store_unit]

             {CLEAR_VARIABLE escape_secured,turn_counter,located_go_to,sword_taken}

             [endlevel]
                 result="victory"
                 {NEW_GOLD_CARRYOVER 20}
                 bonus=yes
             [/endlevel]
          [/then]
       [/if]
       [if]
           {VARIABLE_CONDITIONAL escape_secured equals no}
           [then]
              [message]
                  speaker="Jahin"
                  message= _ "We can't fight the High Methusalem with enemies at our rear. We must kill the leader of the southernmost castle first!"
              [/message]
           [/then]
       [/if]
    [/event]

    {ON_SIGHTING () 1,2,10,11,13 (id="Holt") (

    [message]
       speaker="Holt"
       message= _ "What's this? Invaders are trying to reach my master? I shall not allow this. Reserves!"
    [/message]
    [gold]
       side=7
       amount=800
    [/gold]

    )}

    [event]
       name="moveto"
       first_time_only=yes

       [filter]
           id="Jahin"
           x=34-41
           y=33-37
       [/filter]

       [message]
           speaker="unit"
           message= _ "Hey, this is a dead end!"
       [/message]
       [message]
           speaker="Sreeyoshee"
           message= _ "Maybe there is some sort of secret passage. Let's search more closely."
       [/message]
    [/event]

[/scenario]