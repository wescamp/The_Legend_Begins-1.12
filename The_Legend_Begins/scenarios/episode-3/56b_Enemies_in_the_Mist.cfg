#textdomain wesnoth-The_Legend_Begins

[scenario]
    id="56b_Enemies_in_the_Mist"
    name= _ "Enemies in the Mist"
    next_scenario="57_Battle_of_the_Red_Snow"
    map_data="{~add-ons/The_Legend_Begins/maps/episode-3/56b_Enemies_in_the_Mist.map}"

    {DEFAULT_SCHEDULE}
    {TLB_WEATHER_SNOWFALL}
    {TIME_OVER_DEFEAT}

    victory_when_enemies_defeated=no

    {DEFAULT_MUSIC_PLAYLIST}
    turns=20

    {~add-ons/The_Legend_Begins/macros/deaths.cfg}
    {~add-ons/The_Legend_Begins/macros/recurring-events.cfg}
    {~add-ons/The_Legend_Begins/macros/custom-advancement.cfg}

    # No story this is intentional

    {FORCE_CHANCE_TO_HIT (side=1,2) (id="General1") 0 ()}
    {FORCE_CHANCE_TO_HIT (side=1,2) (id="General2") 0 ()}
    {FORCE_CHANCE_TO_HIT (side=1,2) (id="General3") 0 ()}
    {FORCE_CHANCE_TO_HIT (side=1,2) (id="Ogre1") 30 ()}

# Side 2 gets gold for every unit your army kills!

    [event]
        name="die"
        first_time_only=no
        [filter_second]
             side=1
        [/filter_second]
        [gold]
             side=2
             amount=10
        [/gold]
    [/event]

# Every time an enemy units dies, the enemy gets gold!
 
    [event]
        name="die"
        first_time_only=no
        [filter]
            side=3,4,5,6
        [/filter]

        {VARIABLE_OP units_to_kill add -1}

        [gold]
           side=$unit.side
           amount=12
        [/gold]

        [print]
           text= _ "$units_to_kill units left to kill!"
           size=18
           red,green,blue=255,255,255
        [/print]

        [if]
           {VARIABLE_CONDITIONAL units_to_kill equals 0}
           [then]
               [fire_event]
                   name="objective_completed"
               [/fire_event]
           [/then]
        [/if]
    [/event]


    [event]
        name="die"
        [filter]
            id="Ogre1"
        [/filter]
        [message]
            speaker="Jahin"
            message= _ "This should weaken the enemy a bit!"
        [/message]
    [/event]

# It's time for hard core action!

    [event]
        name="turn 15"

        [message]
            speaker="General2"
            message= _ "Fools, our elite have arrived to eradicate you!"
        [/message]
        [message]
            speaker="Fairuz"
            message= _ "Good, more soldiers to kill!"
        [/message]
        [message]
            speaker="Jahin"
            message= _ "I have a feeling that this battle is far from over..."
        [/message]

        [gold]
            side=3,4,6
            amount=600
        [/gold]

        #ifndef HARD
        [allow_recruit]
            side=3,4,6
            type="Halberdier,Master Bowman"
        [/allow_recruit]
        #else
        [allow_recruit]
            side=3,4,6
            type="Halberdier,Master Bowman,Lancer"
        [/allow_recruit]
        #endif
    [/event]

    [event]
        name="objective_completed"

        [message]
            speaker="General2"
            message= _ "The princess has proven herself to be quite a challenge and we are out of provisions. Retreat!"
        [/message]

        [kill]
            side=3,4,6
            animate=no
        [/kill]

        [message]
            speaker="Fairuz"
            message= _ "Yahoo! We're victorious!"
        [/message]

        {FAKE_UNIT_MOVE 1 25 21 23 2 "Owl" ()}
        {GENERIC_UNIT 2 "Owl" 25 23}

        [message]
            speaker="Afrin"
            message= _ "<i>(after reading the note)</i> It's a message from Lord Harold. He says that we must march for the capital as soon as possible for the final battle is at hand. My friends, take rest, for after a day, we shall begin our march."
        [/message]
        [message]
            speaker="Fairuz"
            message= _ "Finally, I can rest and eat!"
        [/message]

        [endlevel]
            result="victory"
            {NEW_GOLD_CARRYOVER 40}
            bonus=yes
        [/endlevel]
    [/event]

    [event]
        name="start"

        [message]
            speaker="Jahin"
            message= _ "Look, everyone! I see the city that Perkins told us about in yonder direction!"
        [/message]
        [scroll_to_unit]
            id="Afrin"
        [/scroll_to_unit]
        {DELAY 1000}

        [message]
            speaker="Afrin"
            message= _ "More enemies? Well, we shall never surrender!"
        [/message]
        [message]
            speaker="Jahin"
            message= _ "Wait, Your Highness, we're not foes! We're here to aid you!"
        [/message]
        [message]
            speaker="Afrin"
            message= _ "Then, are you the allies that Perkins told me about?"
        [/message]
        [message]
            speaker="Jahin"
            message= _ "We are."
        [/message]
        [message]
            speaker="Afrin"
            message= _ "Thank heavens! We have your supplies ready for you, but we must defend the city from the forces of my evil aunt first."
        [/message]
        [message]
            speaker="Fairuz"
            message= _ "Alright. "
        [/message]
    [/event]

    [event]
        name="turn 2"
        [message]
            speaker="Shifti"
            message= _ "Jahin, may I offer advice about the battle that we will be fighting shortly?"
        [/message]
        [message]
            speaker="Jahin"
            message= _ "Sure. I'm always open to suggestions."
        [/message]
        [message]
            speaker="Shifti"
            message= _ "Your enemies seem to be targeting the princess above everything else, so you should move the bulk of your army into the city and fortify its defences."
        [/message]
        [message]
            speaker="Jahin"
            message= _ "Okay."
        [/message]
        [message]
            speaker="Sreeyoshee"
            message= _ "Jahin, I'm a healer so I should fight at the front but, please protect me as I'm not very good when it comes to close combat."
        [/message]
        [message]
            speaker="Fairuz"
            message= _ "Don't worry. Jahin and I will protect you. Now, Jahin, are you up for a challenge?"
        [/message]
        [message]
            speaker="Jahin"
            message= _ "Wait, let me guess. Is it about who can kill the most enemies?"
        [/message]
        [message]
            speaker="Fairuz"
            message= _ "Wait, how did you know?"
        [/message]
        [message]
            speaker="Jahin"
            message= _ "You say the same thing before every battle..."
        [/message]
        [message]
            speaker="Fairuz"
            message= _ "Fair enough. Let's attack!"
        [/message]
        [message]
            speaker="narrator"
            image="wesnoth-icon.png"
            caption= _ "Fairuz's Challenge Bonus"
            message= _ "For every unit Jahin's army kills, your allied leader will receive 10 gold pieces."
        [/message]
    [/event]

    # meaningless dialogue at some turns

    [event]
        name="turn 10"
        [message]
            speaker="General3"
            message= _ "Ready to surrender yet, wench?"
        [/message]
        [message]
            speaker="Afrin"
            message= _ "Go back to the hole you once crawled out from, puppet, for we shall never give in!"
        [/message]
    [/event]

    [event]
        name="turn 13"
        [message]
            speaker="Jahin"
            message= _ "Princess, don't mind me asking but why are you rebelling against your aunt?"
        [/message]
        [message]
            speaker="Afrin"
            message= _ "She's an abomination. She ascended to the throne using the vilest of treacheries and she is also known for practising the dark arts."
        [/message]
        [message]
            speaker="Sreeyoshee"
            message= _ "A necromancer? There are undead about?"
        [/message]
        [message]
            speaker="Afrin"
            message= _ "Yes, that is what she calls her creations."
        [/message]
        [message]
            speaker="Jahin"
            message= _ "I have dealt with undead before. As the trolls are with us, they won't be much of a problem..."
        [/message]
    [/event]

    # My first attempt at a land/sea fight

    [side]
        side=1
        team_name="good"
        user_team_name= _ "New Genesis"
        id="Jahin"
        name= _ "Jahin"
        type="Captain"
        controller=human
        canrecruit=yes
        fog=yes
        share_view=yes
        share_map=no
        {GOLD 120 100 100}
        {FLAG_VARIANT loyalist}
        {INCOME 2 1 0}
    [/side]

    {STARTING_VILLAGES 1 8}

    [side]
        side=2
        team_name="good"
        user_team_name= _ "Rebels"
        id="Afrin"
        name= _ "female^Afrin"
        type="Prowler"
        controller=ai
        fog=yes
        share_view=yes
        share_map=no
        canrecruit=yes
        {GOLD 600 550 500}
        {FLAG_VARIANT long}
        {INCOME 24 22 20}

        #ifdef EASY
        recruit="Northern Archer,Northern Warrior,Northern Strongbow,Northern Fighter,Footpad,Outlaw,Poacher,Trapper,Thug,Bandit,Fencer,Duelist"
        #else
        recruit="Northern Archer,Northern Warrior,Northern Strongbow,Northern Fighter,Footpad,Outlaw,Fencer,Duelist"
        #endif

        [ai]
           {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
           {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
           {AI_SIMPLE_ALWAYS_ASPECT caution 0.4}
           {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_movement yes}
           {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
           {ATTACK_DEPTH 5 5 6}

           [protect_unit]
              id="Afrin"
              value=5000
              radius=8
           [/protect_unit]
          
           [avoid]
              x=1-15,1-54,40-54
              y=1-28,29-43,1-28
           [/avoid]
        [/ai]

        {LOYAL_UNIT 2 "Northern Warrior" 20 17}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 22 16}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 21 18}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 21 17}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 22 15}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 22 14}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 23 15}{GUARDIAN}

        {LOYAL_UNIT 2 "Northern Warrior" 27 28}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 29 27}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 31 26}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 32 24}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 32 23}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 34 22}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 35 22}{GUARDIAN}
   
        {LOYAL_UNIT 2 "Northern Warrior" 19 20}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 18 21}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 18 23}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 19 24}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 20 25}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 22 26}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 25 27}{GUARDIAN}

        {LOYAL_UNIT 2 "Northern Warrior" 36 20}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 36 19}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 16 18}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 35 17}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 34 16}{GUARDIAN}
        {LOYAL_UNIT 2 "Northern Warrior" 34 17}{GUARDIAN}
        
        {LOYAL_UNIT 2 "Transport Galleon" 23 18}{GUARDIAN}
        {LOYAL_UNIT 2 "Transport Galleon" 27 17}{GUARDIAN}
        {LOYAL_UNIT 2 "Transport Galleon" 30 16}{GUARDIAN}
        {LOYAL_UNIT 2 "Transport Galleon" 29 19}{GUARDIAN}
        {LOYAL_UNIT 2 "Transport Galleon" 31 18}{GUARDIAN}
        {LOYAL_UNIT 2 "Transport Galleon" 26 14}{GUARDIAN}
    [/side]

    {STARTING_VILLAGES 2 10}

    {AI_CONTROLLER () 1 2 ()}

    [event]
        name="die"
        [filter]
            id="Afrin"
        [/filter]
        [message]
            speaker="Jahin"
            message= _ "We have failed to protect the princess! Now, we will never get a new ally..."
        [/message]
        [endlevel]
            result="defeat"
        [/endlevel]
    [/event]

    [side]
        side=3
        team_name="bad"
        user_team_name= _ "Royalists"
        type="Grand Knight"
        id="General1"
        generate_name=yes
        {GOLD 300 350 400}
        {INCOME 18 18 18}
        {FLAG_VARIANT loyalist}
        recruit="Fencer,Spearman,Longbowman,Bowman,Pikeman,Duelist,Horseman"
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.2}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_movement yes}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
            {ATTACK_DEPTH 5 5 6}

            [target]
                id="Afrin"
                value=500
            [/target]
        [/ai]
    [/side]

    [side]
        side=4
        team_name="bad"
        user_team_name= _ "Royalists"
        type="Grand Knight"
        id="General2"
        generate_name=yes
        {GOLD 300 350 400}
        {INCOME 18 18 18}
        {FLAG_VARIANT loyalist}
        recruit="Fencer,Spearman,Longbowman,Bowman,Pikeman,Duelist,Horseman"
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.2}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_movement yes}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
            {ATTACK_DEPTH 5 5 6}

            [target]
                id="Afrin"
                value=500
            [/target]
        [/ai]
    [/side]

    [side]
        side=5
        team_name="bad"
        user_team_name= _ "Ogres"
        type="Great Ogre"
        id="Ogre1"
        generate_name=yes
        {GOLD 300 350 400}
        {INCOME 18 18 18}
        {FLAG_VARIANT ragged}
        recruit="Ogre,Great Ogre,Young Ogre,Goblin Impaler,Goblin Cavalry,Goblin Lancer,Goblin Knight,Goblin Pillager,Direwolf Rider"
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.2}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_movement yes}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
            {ATTACK_DEPTH 5 5 6}

            [target]
                id="Afrin"
                value=500
            [/target]
        [/ai]
    [/side]

    [side]
        side=6
        team_name="bad"
        user_team_name= _ "Royalists"
        type="Grand Knight"
        id="General3"
        generate_name=yes
        {GOLD 300 350 400}
        {INCOME 18 18 18}
        {FLAG_VARIANT loyalist}
        recruit="Fencer,Spearman,Longbowman,Bowman,Pikeman,Duelist,Horseman"
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.2}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_movement yes}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
            {ATTACK_DEPTH 5 5 6}

            [target]
                id="Afrin"
                value=500
            [/target]
        [/ai]
    [/side]

    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=turn_number
                less_than=5
            [/variable]

            [then]
                {NOTRAIT_UNIT 3 "Transport Galleon" 1 1}
            [/then]
        [/if]
    [/event]

    [event]
        name=turn refresh
        first_time_only=no

        [if]
            [variable]
                name=side_number
                equals=3
            [/variable]

            [then]
                [store_unit]
                    [filter]
                        type=Transport Galleon
                        side=3

                        [not]
                            [filter_wml]
                                [variables]
                                    destination_set=yes
                                [/variables]
                            [/filter_wml]
                        [/not]
                    [/filter]

                    kill=yes
                    variable=stored_transports
                [/store_unit]

                {FOREACH stored_transports i}
                    [store_locations]
                        x=23-30
                        y=15-19
                        terrain=Ww

                        [filter_adjacent_location]
                            terrain=Aa,Ai,*^Bw*
                        [/filter_adjacent_location]

                        [not]
                            find_in=already_picked_transport_destination_surroundings
                        [/not]

                        variable=possible_transport_destinations
                    [/store_locations]

                    {VARIABLE_OP transport_destination_index rand "1..$possible_transport_destinations.length"}
                    {VARIABLE_OP transport_destination_index sub 1}

                    {VARIABLE stored_transports[$i].variables.destination_x $possible_transport_destinations[$transport_destination_index].x}
                    {VARIABLE stored_transports[$i].variables.destination_y $possible_transport_destinations[$transport_destination_index].y}
                    {VARIABLE stored_transports[$i].variables.destination_set yes}

                    [store_locations]
                        x=$stored_transports[$i].variables.destination_x
                        y=$stored_transports[$i].variables.destination_y
                        radius=2

                        [filter_radius]
                            terrain=Ww,Ai,Aa,*^Bw*
                        [/filter_radius]

                        [or]
                            find_in=already_picked_transport_destination_surroundings
                        [/or]

                        variable=already_picked_transport_destination_surroundings
                    [/store_locations]

                    [unstore_unit]
                        variable=stored_transports[$i]
                    [/unstore_unit]
                {NEXT i}

                [store_unit]
                    [filter]
                        type=Transport Galleon
                        side=3

                        [not]
                            [filter_wml]
                                [variables]
                                    landed=yes
                                [/variables]
                            [/filter_wml]
                        [/not]
                    [/filter]

                    kill=yes
                    variable=stored_transports
                [/store_unit]

                {FOREACH stored_transports i}
                    {VARIABLE stored_transports[$i].goto_x $stored_transports[$i].variables.destination_x}
                    {VARIABLE stored_transports[$i].goto_y $stored_transports[$i].variables.destination_y}

                    [unstore_unit]
                        variable=stored_transports[$i]
                    [/unstore_unit]
                {NEXT i}

                [store_unit]
                    [filter]
                        type=Transport Galleon
                        side=3

                        [filter_wml]
                            [variables]
                                landed=yes
                            [/variables]
                        [/filter_wml]
                    [/filter]

                    kill=yes
                    variable=stored_transports
                [/store_unit]

                {FOREACH stored_transports i}
                    {VARIABLE stored_transports[$i].moves 0}

                    [unstore_unit]
                        variable=stored_transports[$i]
                    [/unstore_unit]
                {NEXT i}

                {CLEAR_VARIABLE stored_transports}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            type=Transport Galleon

            [not]
                [filter_wml]
                    [variables]
                        landed=yes
                    [/variables]
                [/filter_wml]
            [/not]

            [filter_wml]
                [variables]
                    destination_x=$x1
                    destination_y=$y1
                [/variables]
            [/filter_wml]
        [/filter]

        {VARIABLE unit.variables.landed yes}

        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]

        {RANDOM 0..2}

#define ROYALIST_PILLAGER TYPE X Y
    [unit]
        side=3
        type={TYPE}
        x,y={X},{Y}
        random_traits=yes
        generate_name=yes
        moves=0
    [/unit]
#enddef

        [switch]
            variable=random

            [case]
                value=0

                {ROYALIST_PILLAGER Fencer $x1 $y1}
                {ROYALIST_PILLAGER Pikeman $x1 $y1}
                {ROYALIST_PILLAGER Bowman $x1 $y1}
            [/case]

            [case]
                value=1

                {ROYALIST_PILLAGER Horseman $x1 $y1}
                {ROYALIST_PILLAGER Javelineer $x1 $y1}
                {ROYALIST_PILLAGER Bowman $x1 $y1}
            [/case]

            [case]
                value=2

                {ROYALIST_PILLAGER Pikeman $x1 $y1}
                {ROYALIST_PILLAGER Bowman $x1 $y1}
                {ROYALIST_PILLAGER Fencer $x1 $y1}
            [/case]
        [/switch]

        [message]
            side=3
            [filter_adjacent]
                x,y=$x1,$y1
            [/filter_adjacent]
            message= _ "Attack! Letâ€™s kill these rebels!"
        [/message]
    [/event]

    [event]
        name=prestart

        [recall]
            id="Fairuz"
        [/recall]
        [recall]
            id="Sreeyoshee"
        [/recall]
        [recall]
            id="Shifti"
        [/recall]
        [recall]
            id="Krog"
        [/recall]
        [recall]
            id="Kraag"
        [/recall]

# add objectives

        #ifndef EASY
        {VARIABLE units_to_kill 110}
        #else
        {VARIABLE units_to_kill 100}
        #endif

        [objectives]
            [objective]
                 description= _ "Defend the city until the enemy is compelled to retreat."
                 condition="win"
            [/objective]
            [objective]
                 description= _ "Kill $units_to_kill enemy units."
                 condition="win"
            [/objective]
            [objective]
                 description= _ "Death of Jahin"
                 condition="lose"
            [/objective]
            [objective]
                 description= _ "Death of the allied leader."
                 condition="lose"
            [/objective]
            [objective]
                 description= _ "Death of any hero unit."
                 condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [endlevel]
                 carryover_percentage="40"
                 bonus=yes
            [/endlevel]
            
            {AI_CONTROLLER_NOTE}
            [note]
                 description= _ "Units killed by your ally will also be taken into account..."
            [/note]
        [/objectives]

#define ROYALIST_SHIP X Y FACING_VALUE ID_VALUE
    {GENERIC_UNIT 6 "Transport Galleon" {X} {Y}}
    [+unit]
        facing={FACING_VALUE}
        upkeep=free
        role="docked transport"

        [variables]
            transport_num={ID_VALUE}
            dock_x={X}
            dock_y={Y}
        [/variables]

        # Let's make the transports slightly more durable than usual so they're
        # not as easy to destroy...
        [modifications]
            [object]
                [effect]
                    apply_to=hitpoints
                    increase_total=120
                [/effect]
            [/object]
        [/modifications]
    [/unit]
#enddef

        {ROYALIST_SHIP 50 3 sw 1}
        {ROYALIST_SHIP 45 9 se 2}

        [fire_event]
            name=start_boarding_next_transport
        [/fire_event]

    [/event]

    [event]
        name=die
        first_time_only=no

        [filter]
            type=Transport Galleon
            side=6
            [filter_wml]
                [variables]
                    transport_num=$transport_to_board
                [/variables]
            [/filter_wml]
        [/filter]

        {MODIFY_UNIT (
            [filter_wml]
                [variables]
                    boarding_transport=yes
                [/variables]
            [/filter_wml]

            [filter_adjacent]
                x,y=$x1,$y1
            [/filter_adjacent]
        ) variables.boarding_transport no}

        [fire_event]
            name=start_boarding_next_transport
        [/fire_event]
    [/event]

    [event]
        name=side 6 turn refresh
        first_time_only=no

        [filter_condition]
            [have_unit]
                type=Transport Galleon

                [filter_wml]
                    [variables]
                        transport_num=$transport_to_board
                    [/variables]
                [/filter_wml]

                [filter_adjacent]
                    [filter_wml]
                        [variables]
                            boarding_transport=yes
                        [/variables]
                    [/filter_wml]

                    count=3
                [/filter_adjacent]
            [/have_unit]
        [/filter_condition]

        {VARIABLE_OP ships_boarded add 1}
        [switch]
            variable=ships_boarded

            [case]
                value=1

                [message]
                    speaker=General3
                    message= _ "Quickly, board the ship! We shall launch a surprise attack!"
                [/message]
            [/case]
        [/switch]

        [store_unit]
            [filter]
                type=Transport Galleon

                [filter_wml]
                    [variables]
                        transport_num=$transport_to_board
                    [/variables]
                [/filter_wml]
            [/filter]

            kill=no
            variable=transport
        [/store_unit]

        [store_unit]
            [filter]
                [filter_wml]
                    [variables]
                        boarding_transport=yes
                    [/variables]
                [/filter_wml]
            [/filter]

            kill=no
            variable=transport.variables.landing_party
        [/store_unit]

        {FOREACH transport.variables.landing_party i}
            [kill]
                x=$transport.variables.landing_party[$i].x
                y=$transport.variables.landing_party[$i].y
                fire_event=no
            [/kill]

            [move_unit_fake]
                x=$transport.variables.landing_party[$i].x,$transport.x
                y=$transport.variables.landing_party[$i].y,$transport.y
                type=$transport.variables.landing_party[$i].type
                gender=$transport.variables.landing_party[$i].gender
                side=6
            [/move_unit_fake]

            {VARIABLE transport.variables.landing_party[$i].moves 0}
            {VARIABLE transport.variables.landing_party[$i].attacks_left 0}
            {CLEAR_VARIABLE transport.variables.landing_party[$i].variables.boarding_transport}
        {NEXT i}

        [unstore_unit]
            variable=transport
            find_vacant=no
        [/unstore_unit]

        [fire_event]
            name=start_boarding_next_transport
        [/fire_event]

        {CLEAR_VARIABLE transport}
    [/event]

    [event]
        name=side 6 turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                type=Transport Galleon

                [filter_wml]
                    [variables]
                        [landing_party]
                        [/landing_party]
                    [/variables]
                [/filter_wml]
            [/filter]

            kill=no
            variable=moving_transports
        [/store_unit]

        {FOREACH moving_transports i}
            [if]
                [variable]
                    name=moving_transports[$i].x
                    less_than=19
                [/variable]

                [then]
                    {VARIABLE x "1-17"}
                [/then]

                [else]
                    {VARIABLE x "20-30"}
                [/else]
            [/if]

            [store_locations]
                x=$x
                y=15-19
                terrain=W*

                [filter_adjacent_location]
                    terrain=!,W*
                    count=2-6
                [/filter_adjacent_location]

                [not]
                    [filter]
                    [/filter]

                    radius=1
                [/not]

                variable=landing_sites
            [/store_locations]

            #{DEBUG_MSG "Found $landing_sites.length possible landing sites for transport $moving_transports[$i].variables.transport_num"}

            [if]
                [variable]
                    name=landing_sites.length
                    greater_than_equal_to=1
                [/variable]

                [then]
                    {RANDOM "0..$($landing_sites.length - 1)"}

                    {VARIABLE goto_x $landing_sites[$random].x}
                    {VARIABLE goto_y $landing_sites[$random].y}

                    {VARIABLE moving_transports[$i].goto_x $goto_x}
                    {VARIABLE moving_transports[$i].goto_y $goto_y}

                    #{DEBUG_MSG "Setting transport $moving_transports[$i].variables.transport_num to goto $goto_x|,$goto_y"}

                    [unstore_unit]
                        variable=moving_transports[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT i}

        {CLEAR_VARIABLE moving_transports,landing_sites,x,goto_x,goto_y}
    [/event]

     [event]
        name=side 6 turn refresh
        first_time_only=no

        [filter_condition]
            [have_unit]
                [filter_wml]
                    [variables]
                        boarding_transport=yes
                    [/variables]
                [/filter_wml]

                count=0-2
            [/have_unit]
        [/filter_condition]

        {VARIABLE i 0}
        [while]
            [variable]
                name=possible_boarders.length
                less_than=1
            [/variable]

            [variable]
                name=i
                less_than=6
            [/variable]

            [do]
                [store_unit]
                    [filter]
                        side=6
                        canrecruit=no

                        [not]
                            type=Transport Galleon
                        [/not]

                        [filter_wml]
                            hitpoints=$this_unit.max_hitpoints
                        [/filter_wml]

                        [not]
                            [filter_wml]
                                [variables]
                                    boarding_transport=yes
                                [/variables]
                            [/filter_wml]
                        [/not]

                        [and]
                            [filter_location]
                                [filter]
                                    type=Transport Galleon

                                    [filter_wml]
                                        [variables]
                                            transport_num=$transport_to_board
                                        [/variables]
                                    [/filter_wml]
                                [/filter]

                                radius="$($this_unit.moves + min($i,$this_unit.moves))"

                                [filter_radius]
                                    terrain=A*,R*,C*,K*,*^V*,Wwf
                                [/filter_radius]
                            [/filter_location]
                        [/and]
                    [/filter]

                    kill=no
                    variable=possible_boarders
                [/store_unit]

                {VARIABLE_OP i add 1}
            [/do]
        [/while]

        [if]
            [variable]
                name=possible_boarders.length
                greater_than_equal_to=1
            [/variable]

            [then]
                {RANDOM "0..$($possible_boarders.length - 1)"}

                {VARIABLE possible_boarders[$random].variables.boarding_transport yes}

                #{DEBUG_MSG "Setting $possible_boarders[$random].name the $possible_boarders[$random].language_name to board transport $transport_to_board"}

                [unstore_unit]
                    variable=possible_boarders[$random]
                    find_vacant=no
                [/unstore_unit]
            [/then]

            #[else]
            #    {DEBUG_MSG "Found no one to go to board transport $transport_to_board|..."}
            #[/else]
        [/if]

        {CLEAR_VARIABLE possible_boarders}
    [/event]

    # This makes units which have been designated to board a transport to move
    # towards the current transport to board.
    [event]
        name=side 6 turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                side=6

                [filter_wml]
                    [variables]
                        boarding_transport=yes
                    [/variables]
                [/filter_wml]

                [not]
                    [filter_adjacent]
                        [filter_wml]
                            [variables]
                                transport_num=$transport_to_board
                            [/variables]
                        [/filter_wml]
                    [/filter_adjacent]
                [/not]
            [/filter]

            kill=no
            variable=moving_to_transport
        [/store_unit]

        {FOREACH moving_to_transport i}
            # First we try to find a proper boarding location which the unit can
            # reach in one turn...
            [store_locations]
                terrain=!,W*

                [filter_adjacent_location]
                    [filter]
                        [filter_wml]
                            [variables]
                                transport_num=$transport_to_board
                            [/variables]
                        [/filter_wml]
                    [/filter]
                [/filter_adjacent_location]

                [not]
                    [filter]
                    [/filter]
                [/not]

                [and]
                    [filter]
                        x,y=$moving_to_transport[$i].x,$moving_to_transport[$i].y
                    [/filter]

                    radius=$moving_to_transport[$i].moves

                    [filter_radius]
                        terrain=A*,R*,C*,K*,*^V*,Wwf
                    [/filter_radius]
                [/and]

                variable=boarding_locs
            [/store_locations]

            # ...but if no such location was found, then we just make the unit
            # head for the transport itself for now.
            [if]
                [variable]
                    name=boarding_locs.length
                    less_than=1
                [/variable]

                [then]
                    [store_locations]
                        [filter]
                            [filter_wml]
                                [variables]
                                    transport_num=$transport_to_board
                                [/variables]
                            [/filter_wml]
                        [/filter]

                        variable=boarding_locs
                    [/store_locations]
                [/then]
            [/if]

            {RANDOM "0..$($boarding_locs.length - 1)"}

            {VARIABLE moving_to_transport[$i].goto_x $boarding_locs[$random].x}
            {VARIABLE moving_to_transport[$i].goto_y $boarding_locs[$random].y}

            #{DEBUG_MSG "Setting $moving_to_transport[$i].name the $moving_to_transport[$i].language_name to go to $boarding_locs[$random].x|,$boarding_locs[$random].y"}

            [unstore_unit]
                variable=moving_to_transport[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}

        {CLEAR_VARIABLE moving_to_transport,boarding_locs}
    [/event]

    [event]
        name=side 6 turn refresh
        first_time_only=no

        # Zero the movement of docked transports
        {MODIFY_UNIT (
            type=Transport Galleon
            x,y=$this_unit.variables.dock_x,$this_unit.variables.dock_y

            [not]
                [filter_wml]
                    [variables]
                        [landing_party]
                        [/landing_party]
                    [/variables]
                [/filter_wml]
            [/not]
        ) moves 0}

        # Zero the movement of units waiting to board a transport
        {MODIFY_UNIT (
            side=6

            [filter_wml]
                [variables]
                    boarding_transport=yes
                [/variables]
            [/filter_wml]
            [filter_adjacent]
                [filter_wml]
                    [variables]
                        transport_num=$transport_to_board
                    [/variables]
                [/filter_wml]
            [/filter_adjacent]
        ) moves 0}
    [/event]

    # When a transport reaches the northern shore in a spot which has at least 3
    # adjacent free non-deep hexes, so that there's enough space to unload the
    # whole landing party.
    [event]
        name=moveto
        first_time_only=no

        [filter]
            type=Transport Galleon
            side=6
            [filter_location]
                x=1-50
                y=15-19

                [filter_adjacent_location]
                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    terrain=!,W*
                    count=1-6
                [/filter_adjacent_location]

                [and]
                    [filter_adjacent_location]
                        [not]
                            [filter]
                            [/filter]
                        [/not]

                        terrain=!,Wo
                        count=3-6
                    [/filter_adjacent_location]
                [/and]
            [/filter_location]
        [/filter]

        {FOREACH unit.variables.landing_party i}
            [store_locations]
                terrain=!,W*

                [filter_adjacent_location]
                    x,y=$x1,$y1
                [/filter_adjacent_location]

                [not]
                    [filter]
                    [/filter]
                [/not]

                variable=disembark_loc
            [/store_locations]

            [if]
                [variable]
                    name=disembark_loc.length
                    less_than=1
                [/variable]

                [then]
                    [store_locations]
                        terrain=!,Wo

                        [filter_adjacent_location]
                            x,y=$x1,$y1
                        [/filter_adjacent_location]

                        [not]
                            [filter]
                            [/filter]
                        [/not]

                        variable=disembark_loc
                    [/store_locations]
                [/then]
            [/if]

            [move_unit_fake]
                x=$unit.x,$disembark_loc.x
                y=$unit.y,$disembark_loc.y
                type=$unit.variables.landing_party[$i].type
                gender=$unit.variables.landing_party[$i].gender
                side=6
            [/move_unit_fake]

            [unstore_unit]
                variable=unit.variables.landing_party[$i]
                x,y=$disembark_loc.x,$disembark_loc.y
            [/unstore_unit]
        {NEXT i}

        {VARIABLE_OP landing_parties_landed add 1}
        [switch]
            variable=landing_parties_landed

            [case]
                value=1

                [message]
                    x,y=$disembark_loc.x,$disembark_loc.y
                    message= _ "Charge!"
                [/message]
            [/case]

            [case]
                value=2

                [message]
                    x,y=$disembark_loc.x,$disembark_loc.y
                    message= _ "Get them!"
                [/message]
            [/case]
        [/switch]

        {CLEAR_VARIABLE unit.variables.landing_party}

        {VARIABLE unit.moves 0}

        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    [/event]

    # This makes transports which have no landing party and aren't at their dock
    # location to return to their dock. This should only be the case when a
    # transport has unloaded their landing party but hasn't yet returned.
    [event]
        name=side 6 turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                type=Transport Galleon
                side=6
                [not]
                    x,y=$this_unit.variables.dock_x,$this_unit.variables.dock_y
                [/not]

                [not]
                    [filter_wml]
                        [variables]
                            [landing_party]
                            [/landing_party]
                        [/variables]
                    [/filter_wml]
                [/not]
            [/filter]

            kill=yes
            variable=returning_transports
        [/store_unit]

        {FOREACH returning_transports i}
            {VARIABLE returning_transports[$i].goto_x $returning_transports[$i].variables.dock_x}
            {VARIABLE returning_transports[$i].goto_y $returning_transports[$i].variables.dock_y}

            #{DEBUG_MSG "Setting transport $returning_transports[$i].variables.transport_num to return to $returning_transports[$i].variables.dock_x|,$returning_transports[$i].variables.dock_y"}

            [unstore_unit]
                variable=returning_transports[$i]
            [/unstore_unit]
        {NEXT i}

        {CLEAR_VARIABLE returning_transports}
    [/event]

    # This event simply cycles the variable $transport_to_board through values
    # of 1,2,3,4,1,2,3,4,1,2,..., starting from whatever value it is originally
    # set to (if not, then the first call to this sets it to 1).
    [event]
        name=start_boarding_next_transport
        first_time_only=no

        {VARIABLE i $transport_to_board}
        [if]
            [variable]
                name=i
                less_than=4
            [/variable]

            [then]
                {VARIABLE_OP i add 1}
            [/then]

            [else]
                {VARIABLE i 1}
            [/else]
        [/if]
        [while]
            [not]
                [have_unit]
                    type=Transport Galleon
                    side=6
                    [filter_wml]
                        [variables]
                            transport_num=$i
                        [/variables]
                    [/filter_wml]
                [/have_unit]
            [/not]

            [not]
                [variable]
                    name=i
                    numerical_equals=$transport_to_board
                [/variable]
            [/not]

            [do]
                [if]
                    [variable]
                        name=i
                        less_than=4
                    [/variable]

                    [then]
                        {VARIABLE_OP i add 1}
                    [/then]

                    [else]
                        {VARIABLE i 1}
                    [/else]
                [/if]
            [/do]
        [/while]

        #{DEBUG_MSG "Next transport to board is transport $i"}

        {VARIABLE transport_to_board $i}
    [/event]


[/scenario]